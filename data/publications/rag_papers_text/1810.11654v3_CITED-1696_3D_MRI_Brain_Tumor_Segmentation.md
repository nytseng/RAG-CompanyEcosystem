8 1 0 2

v o N 9 1

]

V C . s c [

3 v 4 5 6 1 1 . 0 1 8 1 : v i X r a

3D MRI brain tumor segmentation using autoencoder regularization

Andriy Myronenko

NVIDIA, Santa Clara, CA amyronenko@nvidia.com

Abstract. Automated segmentation of brain tumors from 3D magnetic resonance images (MRIs) is necessary for the diagnosis, monitoring, and treatment planning of the disease. Manual delineation practices require anatomical knowledge, are expensive, time consuming and can be in- accurate due to human error. Here, we describe a semantic segmenta- tion network for tumor subregion segmentation from 3D MRIs based on encoder-decoder architecture. Due to a limited training dataset size, a variational auto-encoder branch is added to reconstruct the input image itself in order to regularize the shared decoder and impose additional con- straints on its layers. The current approach won 1st place in the BraTS 2018 challenge.

1

Introduction

Brain tumors are categorized into primary and secondary tumor types. Primary brain tumors originate from brain cells, whereas secondary tumors metastasize into the brain from other organs. The most common type of primary brain tu- mors are gliomas, which arise from brain glial cells. Gliomas can be of low-grade (LGG) and high-grade (HGG) subtypes. High grade gliomas are an aggressive type of malignant brain tumor that grow rapidly, usually require surgery and radiotherapy and have poor survival prognosis. Magnetic Resonance Imaging (MRI) is a key diagnostic tool for brain tumor analysis, monitoring and surgery planning. Usually, several complimentary 3D MRI modalities are acquired - such as T1, T1 with contrast agent (T1c), T2 and Fluid Attenuation Inversion Re- cover (FLAIR) - to emphasize diﬀerent tissue properties and areas of tumor spread. For example the contrast agent, usually gadolinium, emphasizes hyper- active tumor subregions in T1c MRI modality.

Automated segmentation of 3D brain tumors can save physicians time and provide an accurate reproducible solution for further tumor analysis and mon- itoring. Recently, deep learning based segmentation techniques surpassed tra- ditional computer vision methods for dense semantic segmentation. Convolu- tional neural networks (CNN) are able to learn from examples and demonstrate state-of-the-art segmentation accuracy both in 2D natural images [6] and in 3D medical image modalities [19].

Multimodal Brain Tumor Segmentation Challenge (BraTS) aims to evalu- ate state-of-the-art methods for the segmentation of brain tumors by provid- ing a 3D MRI dataset with ground truth tumor segmentation labels annotated

2

A. Myronenko

by physicians [5,18,4,2,3]. This year, BraTS 2018 training dataset included 285 cases (210 HGG and 75 LGG), each with four 3D MRI modalities (T1, T1c, T2 and FLAIR) rigidly aligned, resampled to 1x1x1 mm isotropic resolution and skull-stripped. The input image size is 240x240x155. The data were collected from 19 institutions, using various MRI scanners. Annotations include 3 tumor subregions: the enhancing tumor, the peritumoral edema, and the necrotic and non-enhancing tumor core. The annotations were combined into 3 nested sub- regions: whole tumor (WT), tumor core (TC) and enhancing tumor (ET), as shown in Figure 2. Two additional datasets without the ground truth labels were provided for validation and testing. These datasets required participants to upload the segmentation masks to the organizers’ server for evaluations. The validation dataset (66 cases) allowed multiple submissions and was designed for intermediate evaluations. The testing dataset (191 cases) allowed only a single submission, and was used to calculate the ﬁnal challenge ranking.

In this work, we describe our semantic segmentation approach for volumetric 3D brain tumor segmentation from multimodal 3D MRIs, which won the BraTS 2018 challenge. We follow the encoder-decoder structure of CNN, with asym- metrically large encoder to extract deep image features, and the decoder part reconstructs dense segmentation masks. We also add the variational autoencoder (VAE) branch to the network to reconstruct the input images jointly with seg- mentation in order to regularize the shared encoder. At inference time, only the main segmentation encode-decoder part is used.

2 Related work

Last year, BraTS 2017, top performing submissions included Kamnitsas et al. [13] who proposed to ensemble several models for robust segmentation (EMMA), and Wang et al. [21] who proposed to segment tumor subregions in cascade using anisotropic convolutions. EMMA takes advantage of an ensemble of several inde- pendently trained architectures. In particular, EMMA combined DeepMedic [14], FCN [16] and U-net [20] models and ensembled their segmentation predictions. During training they used a batch size of 8, and a crop of 64x64x64 3D patch. EMMA’s ensemble of diﬀerent models demonstrated a good generalization per- formance winning the BraTS 2017 challenge. Wang et al. [21] second place paper took a diﬀerent approach, by training 3 networks for each tumor subregion in cascade, with each subsequent network taking the output of the previous network (cropped) as its input. Each network was similar in structure and consists of a large encoder part (with dilated convolutions) and a basic decoder. They also decompose the 3x3x3 convolution kernel into intra-slice (3x3x1) and inter-slice (1x1x3) kernel to save on both the GPU memory and the computational time. This year, BraTS 2018 top performing submission (in addition to the current work) included Isensee et al. [12] in the 2nd place, McKinly et al. [17] and Zhou et al. [23], who shared the 3rd place. Isensee et al. [12] demonstrated that a generic U-net architecture with a few minor modiﬁcations is enough to achieve competitive performance. The authors used a batch size of 2 and a crop size of

3D MRI brain tumor segmentation using autoencoder regularization

128x128x128. Furthermore, the authors used an additional training data from their own institution (which yielded some improvements for the enhancing tumor dice). McKinly et al. [17] proposed a segmentation CNN in which a DenseNet [11] structure with dilated convolutions was embedded in U-net-like network. The authors also introduce a new loss function, a generalization of binary cross- entropy, to account for label uncertainty. Finally, Zhou et al. [23] proposed to use an ensemble of diﬀerent networks: taking into account multi-scale context information, segmenting 3 tumor subregions in cascade with a shared backbone weights and adding an attention block.

Compared to the related works, we use the largest crop size of 160x192x128 but compromise the batch size to be 1 to be able to ﬁt network into the GPU memory limits. We also output all 3 nested tumor subregions directly after the sigmoid (instead of using several networks or the softmax over the number of classes). Finally, we add an additional branch to regularize the shared encoder, used only during training. We did not use any additional training data and used only the provided training set.

Fig. 1. Schematic visualization of the network architecture. Input is a four channel 3D MRI crop, followed by initial 3x3x3 3D convolution with 32 ﬁlters. Each green block is a ResNet-like block with the GroupNorm normalization. The output of the segmentation decoder has three channels (with the same spatial size as the input) followed by a sigmoid for segmentation maps of the three tumor subregions (WT, TC, ET). The VAE branch reconstructs the input image into itself, and is used only during training to regularize the shared encoder.

3 Methods

Our segmentation approach follows encoder-decoder based CNN architecture with an asymmetrically larger encoder to extract image features and a smaller decoder to reconstruct the segmentation mask [6,7,9,20,19]. We add an additional

3

4

A. Myronenko

branch to the encoder endpoint to reconstruct the original image, similar to auto- encoder architecture. The motivation for using the auto-encoder branch is to add additional guidance and regularization to the encoder part, since the training dataset size is limited. We follow the variational auto-encoder (VAE) approach to better cluster/group the features of the encoder endpoint. We describe the building parts of our networks in the next subsections (see also Figure 1)

3.1 Encoder part

The encoder part uses ResNet [10] blocks, where each block consists of two convolutions with normalization and ReLU, followed by additive identity skip connection. For normalization, we use Group Normalization (GN) [22], which shows better than BatchNorm performance when batch size is small (bath size of 1 in our case). We follow a common CNN approach to progressively down- size image dimensions by 2 and simultaneously increase feature size by 2. For downsizing we use strided convolutions. All convolutions are 3x3x3 with initial number of ﬁlters equal to 32. The encoder endpoint has size 256x20x24x16, and is 8 times spatially smaller than the input image. We decided against further downsizing to preserve more spatial content.

3.2 Decoder part

The decoder structure is similar to the encoder one, but with a single block per each spatial level. Each decoder level begins with upsizing: reducing the number of features by a factor of 2 (using 1x1x1 convolutions) and doubling the spatial dimension (using 3D bilinear upsampling), followed by an addition of encoder output of the equivalent spatial level. The end of the decoder has the same spatial size as the original image, and the number of features equal to the initial input feature size, followed by 1x1x1 convolution into 3 channels and a sigmoid function.

3.3 VAE part

Starting from the encoder endpoint output, we ﬁrst reduce the input to a low dimensional space of 256 (128 to represent mean, and 128 to represent std). Then, a sample is drawn from the Gaussian distribution with the given mean and std, and reconstructed into the input image dimensions following the same architecture as the decoder, except we don’t use the inter-level skip connections from the encoder here. The VAE part structure is shown in Table 1.

3.4 Loss

Our loss function consists of 3 terms:

L = Ldice + 0.1 ∗ LL2 + 0.1 ∗ LKL

(1)

3D MRI brain tumor segmentation using autoencoder regularization

Table 1. VAE decoder branch structure, where GN stands for group normalization (with group size of 8), Conv - 3x3x3 convolution, Conv1 - 1x1x1 convolution, AddId - addition of identity/skip connection, UpLinear - 3D linear spatial upsampling, Dense - fully connected layer

Name

Ops

Repeat

Output size

VD

VDraw

GN, ReLU, Conv (16) stride 2, Dense (256) sample ∼ N(µ(128), σ2(128))

1

1

256x1

128x1

VU

Dense, ReLU, Conv1, UpLinear

1

256x20x24x16

VUp2

Conv1, UpLinear

1

128x40x48x32

VBlock2 GN,ReLU,Conv,GN,ReLU,Conv, AddId

1

128x40x48x32

VUp1

Conv1, UpLinear,

1

64x80x96x64

VBlock1 GN,ReLU,Conv,GN,ReLU,Conv, AddId

1

64x80x96x64

VUp0

Conv1, UpLinear,

1

32x160x192x128

VBlock0 GN,ReLU,Conv,GN,ReLU,Conv, AddId

1

32x160x192x128

Vend

Conv1

1

4x160x192x128

Ldice is a soft dice loss [19] applied to the decoder output ppred to match the segmentation mask ptrue:

Ldice =

2 ∗ (cid:80)ptrue ∗ ppred true + (cid:80)p2

(cid:80)p2

pred + (cid:15)

where summation is voxel-wise, and (cid:15) is a small constant to avoid zero division. Since the output of the segmentation decoder has 3 channels (predictions for each tumor subregion), we simply add the three dice loss functions together.

LL2 is an L2 loss on the VAE branch output Ipred to match the input image

Iinput:

LL2 = ||Iinput − Ipred||2 2

LKL is standard VAE penalty term [15,8], a KL divergence between the estimated normal distribution N(µ,σ2) and a prior distribution N(0,1), which has a closed form representation:

LKL =

1 N

(cid:88)

µ2 + σ2 − logσ2 − 1

where N is total number of image voxels. We empirically found a hyper-parameter weight of 0.1 to provide a good balance between dice and VAE loss terms in Equation 1.

5

(2)

(3)

(4)

6

A. Myronenko

3.5 Optimization

We use Adam optimizer with initial learning rate of α0 = 1e−4 and progressively decrease it according to:

α = α0 ∗

(cid:18)

1 −

e Ne

(cid:19)0.9

where e is an epoch counter, and Ne is a total number of epochs (300 in our case). We use batch size of 1, and draw input images in random order (ensuring that each training image is drawn once per epoch).

3.6 Regularization

We use L2 norm regularization on the convolutional kernel parameters with a weight of 1e − 5. We also use the spatial dropout with a rate of 0.2 after the initial encoder convolution. We have experimented with other placements of the dropout (including placing dropout layer after each convolution), but did not ﬁnd any additional accuracy improvements.

3.7 Data preprocessing and augmentation

We normalize all input images to have zero mean and unit std (based on non- zero voxels only). We apply a random (per channel) intensity shift (−0.1..0.1 of image std) and scale (0.9..1.1) on input image channels. We also apply a random axis mirror ﬂip (for all 3 axes) with a probability 0.5.

4 Results

We implemented our network in Tensorﬂow [1] and trained it on NVIDIA Tesla V100 32GB GPU using BraTS 2018 training dataset (285 cases) without any ad- ditional in-house data. During training we used a random crop of size 160x192x128, which ensures that most image content remains within the crop area. We con- catenated 4 available 3D MRI modalities into the 4 channel image as an input. The output of the network is 3 nested tumor subregions (after the sigmoid).

We report the results of our approach on BraTS 2018 validation (66 cases) and the testing sets (191 cases). These datasets were provided with unknown glioma grade and unknown segmentation. We uploaded our segmentation results to the BraTS 2018 server for evaluation of per class dice, sensitivity, speciﬁcity and Hausdorﬀ distances.

Aside from evaluating a single model, we also applied test time augmentation (TTA) by mirror ﬂipping the input 3D image axes, and averaged the output of the resulting 8 ﬂipped segmentation probability maps. Finally, we ensembled a set of 10 models (trained from scratch) to further improve the performance.

Table 2 shows the results of our model on the BraTS 2018 validation dataset. At the time of initial short paper submission (Jul 13, 2018), our dice accuracy performance was second best (team name NVDLMED1) for all of the 3 segmenta-

1 https://www.cbica.upenn.edu/BraTS18/lboardValidation.html

(5)

3D MRI brain tumor segmentation using autoencoder regularization

Fig. 2. A typical segmentation example with true and predicted labels overlaid over T1c MRI axial, sagittal and coronal slices. The whole tumor (WT) class includes all visible labels (a union of green, yellow and red labels), the tumor core (TC) class is a union of red and yellow, and the enhancing tumor core (ET) class is shown in yellow (a hyperactive tumor part). The predicted segmentation results match the ground truth well.

tion labels (ET, WT, TC). The TTA only marginally improved the performance, but the ensemble of 10 models resulted in 1% improvement, which is consistent with the literature results of using ensembles.

For the testing dataset, only a single submission was allowed. Our results are

shown in Table 3, which won the 1st place at BraTS 2018 challenge.

Table 2. BraTS 2018 validation dataset results. Mean Dice and Hausdorﬀ measure- ments of the proposed segmentation method. EN - enhancing tumor core, WT - whole tumor, TC - tumor core.

Dice

Hausdorﬀ (mm)

Validation dataset

ET WT

TC

ET WT

TC

Single Model

0.8145 0.9042 0.8596 3.8048 4.4834 8.2777

Single Model + TTA 0.8173 0.9068 0.8602 3.8241 4.4117 6.8413

Ensemble of 10 models 0.8233 0.9100 0.8668 3.9257 4.5160 6.8545

Time-wise, each training epoch (285 cases) on a single GPU (NVIDIA Tesla V100 32GB) takes 9min. Training the model for 300 epochs takes 2 days. We’ve also trained the model on NVIDIA DGX-1 server (that includes 8 V100 GPUs

7

8

A. Myronenko

Table 3. BraTS 2018 testing dataset results. Mean Dice and Hausdorﬀ measurements of the proposed segmentation method. EN - enhancing tumor core, WT - whole tumor, TC - tumor core.

Dice

Hausdorﬀ (mm)

Testing dataset

ET WT

TC

ET WT

TC

Ensemble of 10 models 0.7664 0.8839 0.8154 3.7731 5.9044 4.8091

interconnected with NVLink); this allowed to train the model in 6 hours ( 7.8x speed up). The inference time is 0.4 sec for a single model on a single V100 GPU.

5 Discussion and Conclusion

In this work, we described a semantic segmentation network for brain tumor segmentation from multimodal 3D MRIs, which won the BraTS 2018 challenge. While experimenting with network architectures, we have tried several alterna- tive approaches. For instance, we have tried a larger batch size of 8 to be able to use BatchNorm (and take advantage of batch statistics), however due to the GPU memory limits this modiﬁcation required to use a smaller image crop size, and resulted in worse performance. We have also experimented with more sophis- ticated data augmentation techniques, including random histogram matching, aﬃne image transforms, and random image ﬁltering, which did not demonstrate any additional improvements. We have tried several data post-processing tech- niques to ﬁne tune the segmentation predictions with CRF [14], but did not ﬁnd it beneﬁcial (it helped for some images, but made some other image segmenta- tion results worse). Increasing the network depth further did not improve the performance, but increasing the network width (the number of features/ﬁlters) consistently improved the results. Using the NVIDIA Volta V100 32GB GPU we were able to double the number of features compared to V100 16GB version. Finally, the additional VAE branch helped to regularize the shared encoder (in presence of limited data), which not only improved the performance, but helped to consistently achieve good training accuracy for any random initialization. Our BraTS 2018 testing dataset results are 0.7664, 0.8839 and 0.8154 average dice for enhanced tumor core, whole tumor and tumor core, respectively.

References

1. Abadi, M., Agarwal, A., Barham, P., Brevdo, E., Chen, Z., Citro, C., Corrado, G.S., Davis, A., Dean, J., Devin, M., Ghemawat, S., Goodfellow, I., Harp, A., Irving, G., Isard, M., Jia, Y., Jozefowicz, R., Kaiser, L., Kudlur, M., Levenberg, J., Man´e, D., Monga, R., Moore, S., Murray, D., Olah, C., Schuster, M., Shlens, J., Steiner, B., Sutskever, I., Talwar, K., Tucker, P., Vanhoucke, V., Vasudevan, V., Vi´egas, F., Vinyals, O., Warden, P., Wattenberg, M., Wicke, M., Yu, Y., Zheng, X.: TensorFlow: Large-scale machine learning on heterogeneous systems (2015), https://www.tensorflow.org/, software available from tensorﬂow.org

3D MRI brain tumor segmentation using autoencoder regularization

2. Bakas, S., Akbari, H., Sotiras, A., Bilello, M., Rozycki, M., Kirby, J., John Frey- mann, K.F., Davatzikos, C.: Segmentation labels and radiomic features for the pre- operative scans of the tcga-gbm collection. The Cancer Imaging Archive (2017), https://doi.org/10.7937/K9/TCIA.2017.KLXWJJ1Q

3. Bakas, S., Akbari, H., Sotiras, A., Bilello, M., Rozycki, M., Kirby, J., John Frey- mann, K.F., Davatzikos, C.: Segmentation labels and radiomic features for the pre-operative scans of the tcga-lgg collection. The Cancer Imaging Archive (2017), https://doi.org/10.7937/K9/TCIA.2017.GJQ7R0EF

4. Bakas, S., Akbari, H., Sotiras, A., Bilello, M., Rozycki, M., Kirby, J., Freymann, J., Farahani, K., Davatzikos, C.: Advancing the cancer genome atlas glioma mri collections with expert segmentation labels and radiomic features. Scientiﬁc data 4 (9 2017)

5. Bakas, S., Reyes, M., et Int, Menze, B.: Identifying the best machine learning algo- rithms for brain tumor segmentation, progression assessment, and overall survival prediction in the BRATS challenge. In: arXiv:1811.02629 (2018)

6. Chen, L.C., Zhu, Y., Papandreou, G., Schroﬀ, F., Adam, H.: Encoder-decoder with atrous separable convolution for semantic image segmentation. arXiv:1802.02611 (2018)

7. Chollet, F.: Xception: Deep learning with depthwise separable convolutions. In: IEEE Conference on Computer Vision and Pattern Recognition. pp. 1800–1807 (2017)

8. Doersch, C.: Tutorial on variational autoencoders, arxiv e-print (2016), http:// arxiv.org/abs/1606.05908

9. He, K., Gkioxari, G., Dollar, P., Girshick, R.: Mask r-cnn. In: Proceedings of the International Conference on Computer Vision (ICCV) (2017)

10. He, K., Zhang, X., Ren, S., Sun, J.: Identity mappings in deep residual networks. In: European Conference on Computer Vision (ECCV) (2016)

11. Huang, G., Liu, Z., van der Maaten, L., Weinberger, K.Q.: Densely connected convolutional networks. In: Proceedings of the IEEE Conference on Computer Vision and Pattern Recognition. pp. 2261–2269 (2017)

12. Isensee, F., Kickingereder, P., Wick, W., Bendszus, M., Maier-Hein, K.H.: No new- net. In: International Conference on Medical Image Computing and Computer As- sisted Intervention (MICCAI 2018). Multimodal Brain Tumor Segmentation Chal- lenge (BraTS 2018). BrainLes 2018 workshop. LNCS, Springer (2018)

13. Kamnitsas, K., W. Bai, E.F., McDonagh, S., Sinclair, M., Pawlowski, N., Rajchl, M., Lee, M., Kainz, B., Rueckert, D., Glocker, B.: Ensembles of multiple models and architectures for robust brain tumour segmentation. In: International Conf. on Medical Image Computing and Computer Assisted Intervention. Multimodal Brain Tumor Segmentation Challenge (MICCAI, 2017). LNCS

14. Kamnitsas, K., Ledig, C., andJoanna P. Simpson, V.F.N., Kane, A.D., Menon, D.K., Rueckert, D., , Glocker, B.: Eﬃcient multi-scale 3d cnn with fully connected crf for accurate brain lesion segmentation. Medical Image Analysis (2016)

15. Kingma, D.P., Welling, M.: Auto-encoding variational bayes. In: The International Conference on Learning Representations (ICLR) (2014)

16. Long, J., Shelhamer, E., Darrell, T.: Fully convolutional networks for semantic seg- mentation. In: The IEEE Conference on Computer Vision and Pattern Recognition (CVPR). pp. 3431–3440 (2015)

17. McKinley, R., Meier, R., Wiest, R.: Ensembles of densely-connected cnns with label-uncertainty for brain tumor segmentation. In: International Conference on Medical Image Computing and Computer Assisted Intervention (MICCAI 2018).

9

10

A. Myronenko

Multimodal Brain Tumor Segmentation Challenge (BraTS 2018). BrainLes 2018 workshop. LNCS, Springer (2018)

18. Menze, B.H., Jakab, A., Bauer, S., Kalpathy-Cramer, J., Farahani, K., Kirby, J., Burren, Y., Porz, N., Slotboom, J., Wiest, R., Lanczi, L., Gerstner, E.R., Weber, M.A., Arbel, T., Avants, B.B., Ayache, N., Buendia, P., Collins, D.L., Cordier, N., Corso, J.J., Criminisi, A., Das, T., Delingette, H., Demiralp, C., Durst, C.R., Dojat, M., Doyle, S., Festa, J., Forbes, F., Geremia, E., Glocker, B., Golland, P., Guo, X., Hamamci, A., Iftekharuddin, K.M., Jena, R., John, N.M., Konukoglu, E., Lashkari, D., Mariz, J.A., Meier, R., Pereira, S., Precup, D., Price, S.J., Raviv, T.R., Reza, S.M.S., Ryan, M.T., Sarikaya, D., Schwartz, L.H., Shin, H.C., Shotton, J., Silva, C.A., Sousa, N., Subbanna, N.K., Szekely, G., Taylor, T.J., Thomas, O.M., Tustison, N.J., Unal, G.B., Vasseur, F., Wintermark, M., Ye, D.H., Zhao, L., Zhao, B., Zikic, D., Prastawa, M., Reyes, M., Leemput, K.V.: The multimodal brain tumor image segmentation benchmark (brats). IEEE Trans. Med. Imaging 34(10), 1993–2024 (2015)

19. Milletari, F., Navab, N., Ahmadi, S.A.: V-net: Fully convolutional neural networks for volumetric medical image segmentation. In: Fourth International Conference on 3D Vision (3DV) (2016)

20. Ronneberger, O., P.Fischer, Brox, T.: U-net: Convolutional networks for biomed- ical image segmentation. In: Medical Image Computing and Computer-Assisted Intervention (MICCAI). LNCS, vol. 9351, pp. 234–241. Springer (2015)

21. Wang, G., Li, W., Ourselin, S., Vercauteren, T.: Automatic brain tumor segmen- tation using cascaded anisotropic convolutional neural networks. In: International Conf. on Medical Image Computing and Computer Assisted Intervention. Multi- modal Brain Tumor Segmentation Challenge (MICCAI, 2017). LNCS

22. Wu, Y., He, K.: Group normalization. In: European Conference on Computer Vi- sion (ECCV) (2018)

23. Zhou, C., Chen, S., Ding, C., Tao, D.: Learning contextual and attentive informa- tion for brain tumor segmentation. In: International Conference on Medical Im- age Computing and Computer Assisted Intervention (MICCAI 2018). Multimodal Brain Tumor Segmentation Challenge (BraTS 2018). BrainLes 2018 workshop. LNCS, Springer (2018)